.content-wrapper
  -# .container
  / Content Header (Page header)
  %section.content-header
    = render 'shared/flash_messages'
    %h3
      %i.fa.fa-male
      = @customer.user_name
      %a{href: edit_customer_path(@customer)}
        %i.fa.fa-pencil
    
    - unless @accounts.blank? or @accounts.count == 1
      .btn-group
        - @accounts.each_with_index do |account, index|
          - unless browser.device.mobile?
            %a.btn{href: customer_path(account_id: account.id), class: "#{@account.id == account.id ? 'bg-orange' : 'btn-default'}", data: {disable_with: "<i class='fa fa-google-wallet'></i> Wallet #{index + 1} <div class='text-center'><small>(#{account.account_type.description})</small></div>"}}
              %i.fa.fa-google-wallet
              Wallet
              = "#{index + 1}"
              .text-center
                %small= "(#{account.account_type.description})"
          - else
            %a.btn{href: customer_path(account_id: account.id), class: "#{@account.id == account.id ? 'bg-orange' : 'btn-default'}", data: {disable_with: "<i class='fa fa-google-wallet'></i> Wallet #{index + 1}"}}
              %i.fa.fa-google-wallet
              Wallet
              = "#{index + 1}"
    %p
      - unless @events.blank?
        .btn-group
          - @events.each do |event|
            %a.btn{href: customer_path(event_id: event.id, account_id: @account.id), class: "#{@event.id == event.id ? 'bg-orange' : 'btn-default'}", data: {disable_with: "<i class='fa fa-calendar'></i> #{event.title.html_safe}"}}
              %i.fa.fa-calendar
              = event.title.html_safe
      - else
        (no events)
      -#
        %br
        = "#{@account.blank? ? 'No company' : @account.company.name}"
    
  / Main content
  %section.content
    / Default box
    .row
      .col-md-3
        / Profile Image
        .box.box-primary
          .box-tools.pull-right
            -#
              %a.btn.btn-box-tool{href: edit_customer_path(@customer), :type => "button"}
                %i.fa.fa-edit.fa-lg
          .box-body.box-profile
            .text-center
              %h5.text-muted
                Balance
                = number_to_currency(@account.blank? ? 0 : @account.balance)
                - if (@account and (@account.can_fund_by_cc? or @account.can_fund_by_ach?)) and not current_user.administrator?
                  %a.btn.btn-sm.btn-default{href: edit_account_path(@account)}
                    %i.fa.fa-credit-card
                    Fund
              -#
                .text-center
                  = "#{@account.blank? ? '' : @account.company.name}"
                  .btn-group-vertical
                    - unless @events.blank?
                      - @events.each do |event|
                        %a.btn{href: customer_path(event_id: event.id), class: "#{@event.id == event.id ? 'btn-info' : 'btn-default'}", data: {disable_with: "<i class='fa fa-calendar'></i> #{event.title}"}}
                          %i.fa.fa-calendar
                          = event.title
                  - if @events.blank?
                    .text-muted (no events)
            %h3.profile-username.text-center
              =# current_user.consumer? ? current_user.full_name : @customer.full_name
              - if @customer.anonymous?
                .text-danger Anonymous Payee
            - if @account and not current_user.administrator?
              = render 'my_code'
              =# render 'barcode'
              =# render 'consumer_qr_code_payment'

            #accordion.panel-group{"aria-multiselectable" => "true", :role => "tablist"}
              - if not current_user.administrator? and @account and @event and @account.can_pull?
                %p
                  .panel.panel-default
                    #headingOne.panel-heading{:role => "tab"}
                      %h4.panel-title
                        %a.btn.btn-lg.btn-success.btn-block{"aria-controls" => "collapseOne", "aria-expanded" => "true", "data-parent" => "#accordion", "data-toggle" => "collapse", :href => "#collapseOne", :role => "button", class: "#{(@account.events.blank? or @event.accounts.can_be_pulled_by_search.blank?) ? 'disabled' : ''}"}
                          %i.fa.fa-long-arrow-right
                          Request Payment
                    #collapseOne.panel-collapse.collapse.in{"aria-labelledby" => "headingOne", :role => "tabpanel"}
                      .panel-body
                        = render 'request_payment'
              - if not current_user.administrator? and @account and @event and @account.balance > 0 and @account.can_send_payment?
                %p
                  .panel.panel-default
                    #headingTwo.panel-heading{:role => "tab"}
                      %h4.panel-title
                        %a.btn.btn-lg.btn-success.btn-block.collapsed{"aria-controls" => "collapseTwo", "aria-expanded" => "false", "data-parent" => "#accordion", "data-toggle" => "collapse", :href => "#collapseTwo", :role => "button", class: "#{@account.events.blank? ? 'disabled' : ''}"}
                          %i.fa.fa-long-arrow-left
                          Send Payment
                    #collapseTwo.panel-collapse.collapse{"aria-labelledby" => "headingTwo", :role => "tabpanel"}
                      .panel-body
                        = render 'send_payment'
              - if not current_user.administrator? and @account and @account.balance > 0 and @account.can_withdraw?
                - unless @account.withdrawal_all?
                  %p
                    .panel.panel-default
                      #headingThree.panel-heading{:role => "tab"}
                        %h4.panel-title
                          %a.btn.btn-lg.btn-success.btn-block.collapsed{"aria-controls" => "collapseThree", "aria-expanded" => "false", "data-parent" => "#accordion", "data-toggle" => "collapse", :href => "#collapseThree", :role => "button"}
                            %i.fa.fa-money
                            Withdrawal
                      #collapseThree.panel-collapse.collapse{"aria-labelledby" => "headingThree", :role => "tabpanel"}
                        .panel-body
                          = render 'withdrawal'
                - else
                  = render 'withdrawal_all'
              -#
                - if @account and @account.balance > 0 and not current_user.administrator?
                  .box.box-success.collapsed-box.box-solid
                    %button.btn.btn-success.btn-block{"data-widget" => "collapse", :type => "button", style: 'color: white;'}
                      %h5
                        %b 
                          %i.fa.fa-long-arrow-left
                          Send Payment
                    .box-body
                      = render 'send_payment'
                  .box.box-success.collapsed-box.box-solid
                    %button.btn.btn-success.btn-block.btn-box-tool{"data-widget" => "collapse", :type => "button", style: 'color: white;'}
                      %h5 
                        %b 
                          %i.fa.fa-money
                          Withdrawal
                    .box-body
                      = render 'withdrawal'
                
            - if @account and current_user.administrator? and not @customer.anonymous?
              %a.btn.btn-success.btn-block{href: '#', "data-toggle" => "modal", "data-target" => "#one_time_payment"}
                %h5
                  %b 
                    %i.fa.fa-dollar
                    One Time Payment
              - if @account and @account.balance > 0 and not @customer.phone.blank?
                %a.btn.btn-default.btn-block{href: send_barcode_sms_message_customer_path(@customer), data: {disable_with: "<i class='fa fa-spinner fa-spin'></i> Send Payment Code"}}
                  %h5
                    %b 
                      %i.fa.fa-money
                      Send Payment Code
              - unless @customer.phone.blank?
                %a.btn.btn-default.btn-block{:href => "#", "data-toggle" => "modal", "data-target" => "#sms_message"}
                  %h5
                    %b 
                      %i.fa.fa-comment
                      Send Message
              = render 'one_time_payment'
              = render 'sms_message'

          / /.box-body
        / /.box
        
        / Details Box
        .box.box-primary
          .box-header.with-border
            %h3.box-title 
              Info
            -#
              .box-tools.pull-right
                %button.btn.btn-box-tool{"data-widget" => "collapse", :type => "button"}
                  %i.fa.fa-minus
          / /.box-header
          .box-body
            %strong 
              %i.fa.fa-user-circle.margin-r-5
              Avatar
            %p.text-center
              - unless @customer.avatar.blank?
                = image_tag(asset_path(@customer.avatar.url), class: 'center image profile-user-img img-responsive img-circle')
              - else
                = image_tag(asset_path('avatar_holder_image.png'), class: 'profile-user-img img-responsive img-circle')
              
            %strong
              %i.fa.fa-envelope.margin-r-5
              Email
            %p.text-muted
              = @customer.user.blank? ? @customer.email : @customer.user.email
            %hr/
            %strong
              %i.fa.fa-mobile.margin-r-5
              Phone
            %p.text-muted
              = @customer.user.blank? ? @customer.phone : @customer.user.phone
            - if current_user.administrator?
              %hr/
              %strong
                %i.fa.fa-user.margin-r-5
                User Web Portal
              %p.text-muted
                - unless @customer.user.blank?
                  - if @customer.user.confirmed?
                    Sign In Count:
                    = @customer.user.sign_in_count
                    %br
                    Current Sign In At:
                    = @customer.user.current_sign_in_at.in_time_zone(current_user.time_zone).strftime('%-m/%-d/%Y') unless @customer.user.current_sign_in_at.blank?
                    %br
                    Last Sign In At:
                    = @customer.user.last_sign_in_at.in_time_zone(current_user.time_zone).strftime('%-m/%-d/%Y') unless @customer.user.last_sign_in_at.blank?
                    %br
                    Current Sign In IP:
                    = @customer.user.current_sign_in_ip
                    %br
                    Last Sign In IP:
                    = @customer.user.last_sign_in_ip
                  - else
                    .text-danger Waiting for user to confirm account
                - else
                  Portal user has not been created
                  - unless @customer.phone.blank?
                    = form_for(@customer) do |f|
                      = f.hidden_field :create_payee_user_flag, :value => true
                      %button.btn.btn-primary{:type => "submit", data: {disable_with: "<i class='fa fa-spinner fa-spin'></i> Send Invite"}}
                        %i.fa.fa-comment
                        Send Invite
              %hr/
              %strong
                %i.fa.fa-file-text-o.margin-r-5
                Notes
              %p.text-muted
                = "EZcash ID: #{@customer.id}"
                - unless @customer.Registration_Source.blank?
                  %br
                  = "Payee ID: #{@customer.Registration_Source}"
                - unless @customer.ssn.blank?
                  %br
                  = "SSN/TIN: ****#{@customer.decrypted_ssn.last(4)}"
              -# %p= link_to 'Delete', @customer, :method => :delete, class: 'btn btn-danger btn-sm', :data => { :confirm => 'Are you sure you want to delete everything connected to this account?' }
            / /.box-body
          / /.box
      .col-md-9
        .box.box-primary
          .box-body
            %ul#myTab.nav.nav-tabs.nav-fill{:role => "tablist"}
              %li.nav-item
                %a#payments-tab.nav-link.active{"aria-controls" => "payments", "aria-selected" => "true", "data-toggle" => "tab", :href => "#payments", :role => "tab"} 
                  %i.fa.fa-dollar.fa-lg
                  = "Payments"
              - if @account and @account.can_withdraw?
                %li.nav-item
                  %a#withdrawals-tab.nav-link{"aria-controls" => "withdrawals", "aria-selected" => "false", "data-toggle" => "tab", :href => "#withdrawals", :role => "tab"} 
                    %i.fa.fa-money.fa-lg
                    = "Withdrawals" 
              -#
                %li.nav-item
                  %a#events-tab.nav-link{"aria-controls" => "events", "aria-selected" => "false", "data-toggle" => "tab", :href => "#events", :role => "tab"} 
                    %i.fa.fa-calendar.fa-lg
                    = "Events" 
              -#
                %li.nav-item
                  %a#checks-tab.nav-link{"aria-controls" => "checks", "aria-selected" => "false", "data-toggle" => "tab", :href => "#checks", :role => "tab"} 
                    %i.fa.fa-bank.fa-lg
                    = "Checks" unless browser.device.mobile?
                  
                  %li.nav-item
                    %a#messages-tab.nav-link{"aria-controls" => "messages", "aria-selected" => "false", "data-toggle" => "tab", :href => "#messages", :role => "tab"} 
                      %i.fa.fa-comments.fa-lg
                      = "Messages" unless browser.device.mobile?
                - else
                  %li.nav-item
                    %a#products-tab.nav-link{"aria-controls" => "products", "aria-selected" => "false", "data-toggle" => "tab", :href => "#products", :role => "tab"} 
                      %i.fa.fa-dropbox.fa-lg
                      = "Products" unless browser.device.mobile?
            #myTabContent.tab-content
              #payments.tab-pane.fade.show.active{"aria-labelledby" => "home-tab", :role => "tabpanel"}
                - unless @payment_transactions.blank?
                  .table-responsive
                    -# %table.table.table-striped{class: "#{browser.device.mobile? ? 'table-sm' : ''}"}
                    %table.table.table-striped
                      %thead
                        %tr
                          %th Date
                          -#
                            %th Description
                          %th To
                          %th From
                          %th Amount
                          -#
                            %th
                      %tbody
                        - @payment_transactions.each do |payment_transaction|
                          %tr{class: payment_transaction.reversed? ? 'table-danger' : ''}
                            %td
                              =# payment_transaction.date_time.in_time_zone(current_user.time_zone).strftime("%^b %d")
                              = link_to payment_transaction.date_time.in_time_zone(current_user.time_zone).strftime("%^b %d"), payment_transaction
                            -#
                              %td= "#{payment_transaction.Description.blank? ? 'N/A' : truncate(payment_transaction.Description, length: 8, omission: '')}"
                            %td
                              - unless payment_transaction.to_account_customer.blank? or (payment_transaction.to_account_customer.full_name.blank? and payment_transaction.to_account_customer.user.full_name.blank?)
                                = payment_transaction.to_account_customer.user.blank? ? payment_transaction.to_account_customer.full_name : payment_transaction.to_account_customer.user.full_name
                              - else
                                = payment_transaction.to_account.company.CompanyName unless payment_transaction.to_account.blank? or payment_transaction.to_account.company.blank?
                            %td
                              - unless payment_transaction.from_account_customer.blank?
                                = payment_transaction.from_account_customer.user.blank? ? payment_transaction.from_account_customer.full_name : payment_transaction.from_account_customer.user.full_name
                              - else
                                = payment_transaction.from_account.company.CompanyName unless payment_transaction.from_account.blank? or payment_transaction.from_account.company.blank?
                            %td= number_to_currency(payment_transaction.amt_auth)
                            -#
                              %td
                                %a{href: "#additional_payment_modal", "data-target" => "#additional_payment_modal", "data-toggle" => "modal"}
                                  Additional Payment
                  - @payment_transactions.each do |payment_transaction|
                    .modal.fade{id: "additional_payment_modal", "aria-labelledby" => "myModalLabel", :role => "dialog", :tabindex => "-1"}
                      .modal-dialog.modal-sm{:role => "document"}
                        .modal-content
                          .modal-header
                            Additional Payment
                            = link_to "×", '#', :class => "close", "data-dismiss" => "modal"
                          .modal-body
                            = form_tag send_payment_transactions_path, method: 'post', class: 'form-horizontal' do |f|
                              = hidden_field_tag :id, payment_transaction.id
                              .input-group.mb-3
                                .input-group-prepend
                                  %span.input-group-text $
                                = number_field_tag :amount, nil, :placeholder => "Amount", class: "form-control input-lg", required: true, step: '1', autofocus: true, :inputmode => "numeric", :min => "0", :pattern => "[0-9]*"
                                .input-group-append
                                  %span.input-group-text .00
                              .modal-footer
                                %button.btn.btn-default{"data-dismiss" => "modal", :type => "button"} Cancel
                                %button.btn.btn-primary{:type => "submit", data: {disable_with: "<i class='fa fa-spinner fa-spin'></i> Submit"}} 
                                  Submit
                          %script
                            $('.modal').on('shown.bs.modal', function() {$(this).find('[autofocus]').first().focus();});
                  .pull-right= paginate @payment_transactions, param_name: 'payments'
                - else
                  .jumbotron
                    %h3.text-center None
              
              #checks.tab-pane.fade{"aria-labelledby" => "profile-tab", :role => "tabpanel"}
                - unless @check_transactions.blank?
                  .table-responsive
                    %table.table.table-striped{class: "#{browser.device.mobile? ? 'table-sm' : ''}"}
                      %thead
                        %tr
                          %th Date
                          %td Description
                          %th Amount
                      %tbody
                        - @check_transactions.each do |check_transaction|
                          %tr
                            %td= link_to check_transaction.date_time.in_time_zone(current_user.time_zone).strftime("%^b %d"), check_transaction
                            %td Check
                            %td= number_to_currency(check_transaction.amt_auth)
                  .pull-right= paginate @check_transactions, param_name: 'checks'
                - else
                  %p.text-center None 

              #withdrawals.tab-pane.fade{"aria-labelledby" => "profile-tab", :role => "tabpanel"}
                - unless @withdrawal_transactions.blank?
                  .table-responsive
                    %table.table.table-striped{class: "#{browser.device.mobile? ? 'table-sm' : ''}"}
                      %thead
                        %tr
                          %th Date
                          %th Description
                          %th Amount
                      %tbody
                        - @withdrawal_transactions.each do |withdrawal_transaction|
                          %tr
                            %td= link_to withdrawal_transaction.date_time.in_time_zone(current_user.time_zone).strftime("%^b %d"), withdrawal_transaction
                            %td= "#{withdrawal_transaction.Description.blank? ? 'N/A' : truncate(withdrawal_transaction.Description, length: 8, omission: '')}"
                            %td= number_to_currency(withdrawal_transaction.amt_auth)
                  .pull-right= paginate @withdrawal_transactions, param_name: 'withdrawals'
                - else
                  .jumbotron
                    %h3.text-center None 

              #messages.tab-pane.fade{"aria-labelledby" => "contact-tab", :role => "tabpanel"}
                - unless @sms_messages.blank?
                  .table-responsive
                    %table.table.table-striped{class: "#{browser.device.mobile? ? 'table-sm' : ''}"}
                      %tbody
                        - @sms_messages.each do |sms_message|
                          %tr
                            %td
                              - unless sms_message.user.blank?
                                = link_to sms_message.user.full_name, sms_message
                              - else
                                = link_to sms_message.company.name, sms_message
                              %br
                              = "#{sms_message.body.blank? ? 'N/A' : truncate(sms_message.body, length: 35)}"
                            %td= sms_message.created_at.in_time_zone(current_user.time_zone).strftime("%^b %d")
                  .pull-right= paginate @sms_messages, param_name: 'messages'
                - else
                  %p.text-center None
              #products.tab-pane.fade{"aria-labelledby" => "contact-tab", :role => "tabpanel"}
                - unless current_user.customer.blank? or current_user.customer.customer_barcodes.blank?
                  .table-responsive
                    %table.table.table-striped
                      %thead
                        %tr
                          %th Barcode
                          %th Amount
                      %tbody
                        - current_user.customer.customer_barcodes.each do |customer_barcode|
                          %tr
                            %td= customer_barcode.Barcode
                            %td= number_to_currency(customer_barcode.amount)
                - else
                  %p.text-center None

= audio_tag asset_path("cash_register.mp3"), class: "cash_register_chime"